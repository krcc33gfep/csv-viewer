<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å®¶è¨ˆç°¿ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼</title>

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1+Code:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  body {
    background: #000; color: #fff; font-family: "M PLUS 1 Code", monospace; margin: 0;
  }
  header {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 10px; background: #111; position: relative;
  }

  /* ğŸ” æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
  .search-wrapper {
    position: relative; width: 100%; max-width: 600px;
  }
  input[type="text"] {
    width: 100%; background: #222; color: #fff;
    border: 1px solid #333; border-radius: 6px;
    padding: 8px 28px 8px 10px; font-size: 16px;
    box-sizing: border-box; transition: box-shadow 0.2s, border-color 0.2s;
  }
  input[type="text"]:focus {
    outline: none; border-color: #0f0; box-shadow: 0 0 6px #0f05;
  }
  .clear-btn {
    position: absolute; right: 22px; top: 50%; transform: translateY(-50%);
    background: none; border: none; color: #aaa; font-size: 20px;
    line-height: 1; cursor: pointer; display: none; padding: 0;
  }
  .clear-btn:hover { color: #fff; }

  .container { padding: 10px; width: 100%; box-sizing: border-box; }
  .row { border-bottom: 1px solid #222; padding: 8px 0; word-break: break-word; }

  .top-line, .bottom-line {
    display: flex; justify-content: space-between; flex-wrap: wrap; align-items: center;
  }

  .date, .category, .classification {
    width: 30%; font-size: 0.9em; color: #ccc;
  }
  .date { color: #aaa; text-align: left; }
  .category { text-align: center; }
  .classification { text-align: right; }

  .desc { flex: 1; font-size: 1em; min-width: 100px; }
  .amount {
    text-align: right; min-width: 80px; font-size: 1.2em; font-weight: 500;
  }
  .amount.minus { color: #0f0; }   /* æ”¯å‡º */
  .amount.plus  { color: #66b2ff; } /* åå…¥ */

  #lastUpdate {
    text-align: center; color: #888; font-size: 0.75em; margin-top: 6px;
  }
</style>
</head>
<body>

<header>
  <div class="search-wrapper">
    <input id="search" type="text" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼š2024å¹´ é£Ÿè²» å¤–é£Ÿï¼‰...">
    <button id="clearBtn" class="clear-btn">&times;</button>
  </div>
  <div id="lastUpdate">æ›´æ–°æƒ…å ±ã‚’å–å¾—ä¸­...</div>
</header>

<div class="container" id="output"></div>

<script>
(() => {
  const csvUrl = "https://docs.google.com/spreadsheets/d/1oJqIz1Rj614hvj-bX5A3jg3uj8Eqxgjvi5do1KYMPds/gviz/tq?tqx=out:csv";
  const infoUrl = "https://script.google.com/macros/s/AKfycbztyxbPuL2IJYrC1b51oLnriV1Ms8n8uTdHKuyiJUNTlER3hULUxyKnNPSXjM9rxdrwaA/exec";

  const search = document.getElementById("search");
  const clearBtn = document.getElementById("clearBtn");
  const output = document.getElementById("output");
  const lastUpdate = document.getElementById("lastUpdate");

  let rows = [];

  /* --- æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --- */
  const parseDate = str => {
    const m = str?.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
    return m ? new Date(m[1], m[2]-1, m[3]) : new Date(0);
  };
  const formatDate = str => {
    const m = str?.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
    return m ? `${m[1]}å¹´${+m[2]}æœˆ${+m[3]}æ—¥` : str || "";
  };

  /* --- CSVãƒ‡ãƒ¼ã‚¿å–å¾— --- */
  async function loadCSV() {
    try {
      const text = await fetch(csvUrl).then(r => r.text());
      const { data } = Papa.parse(text, { header: true, skipEmptyLines: true });
      rows = data.sort((a, b) => parseDate(b['æ—¥ä»˜']) - parseDate(a['æ—¥ä»˜']));
      render(rows);
    } catch (e) {
      console.error("CSVèª­ã¿è¾¼ã¿å¤±æ•—:", e);
    }
  }

  /* --- æ›´æ–°æƒ…å ±å–å¾— --- */
  async function loadUpdateInfo() {
    try {
      const data = await fetch(infoUrl).then(r => r.json());
      lastUpdate.textContent = `æœ€çµ‚æ›´æ–°æ—¥æ™‚ï¼š${data.updated}`;
    } catch {
      lastUpdate.textContent = "æ›´æ–°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
    }
  }

  /* --- æ¤œç´¢å‡¦ç† --- */
  function filterRows(keywordString) {
    const keywords = keywordString.toLowerCase().trim().split(/\s+/);
    if (!keywordString) return rows;

    return rows.filter(r => {
      const fullText = (Object.values(r).join(",") + "," + formatDate(r['æ—¥ä»˜'])).toLowerCase();
      return keywords.every(k => fullText.includes(k));
    });
  }

  /* --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° --- */
  function render(data) {
    output.innerHTML = data.map(r => {
      const amount = parseFloat(r['é‡‘é¡']) || 0;
      const amountClass = amount > 0 ? "plus" : "minus";
      return `
        <div class="row">
          <div class="top-line">
            <div class="date">${formatDate(r['æ—¥ä»˜'])}</div>
            <div class="category">${r['ã‚«ãƒ†ã‚´ãƒª'] || ""}</div>
            <div class="classification">${r['åˆ†é¡'] || ""}</div>
          </div>
          <div class="bottom-line">
            <div class="desc">${r['ãƒ¡ãƒ¢'] || ""}</div>
            <div class="amount ${amountClass}">${r['é‡‘é¡'] || ""}</div>
          </div>
        </div>`;
    }).join("");
  }

  /* --- ã‚¤ãƒ™ãƒ³ãƒˆ --- */
  search.addEventListener("input", e => {
    const value = e.target.value;
    clearBtn.style.display = value ? "block" : "none";
    render(filterRows(value));
  });

  clearBtn.addEventListener("click", () => {
    search.value = "";
    clearBtn.style.display = "none";
    render(rows);
  });

  /* --- åˆæœŸåŒ– --- */
  loadCSV();
  loadUpdateInfo();
})();
</script>

</body>
</html>
